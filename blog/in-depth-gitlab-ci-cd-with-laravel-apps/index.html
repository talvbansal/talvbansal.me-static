
<!DOCTYPE html>
<html lang="en">
    

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="generator" content="TalvBansal.me" />
  <title>In depth Gitlab CI/CD with Laravel Apps - TalvBansal.me</title>
  <meta name="author" content="Talv Bansal" />
  
  <meta name="keywords" content="hexo,gitlab,github,javascript,es6,laravel,php,vue,vue.js,development,full stack,CI/CD," />
   
  <link rel="icon" href="https://talvbansal.me/assets/images/favicon.ico" />
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Talv Bansal","sameAs":["https://github.com/talvbansal","https://twitter.com/talv","https://instagram.com/iwantthewindowseat","https://www.linkedin.com/in/talvinder-bansal-5826594a","mailto:talvbansal@outlook.com"],"image":"https://www.gravatar.com/avatar/be14e67a41106fe8731f839b3bd46733"},"articleBody":"IntroductionMy most read articles on this blog are about Gitlab CI/CD with PHP. They cover a basic linting, testing and crude deploying process.\nToday I want to look at my current CI/CD process for my Laravel projects in more depth. Currently the pipelines of my projects might vary slightly but is very similar to this:\n \n So there are 5 main stages in the process:\n\nPreparation - The pulling down of dependencies and storing them in an artifact\nSyntax - Check code syntax\nTesting - Run unit tests\nBuilding - Build assets\nDeployment - Deploying to an appropriate server\n\nThe stages are processed in order with each stage containing one or many tasks. Should one task fails in a stage then the whole pipeline stops and is marked as failed.\nTo run the pipelines I make use of gitlabs free tier which gives you access to 2000 shared minutes per month as well as a runner on a server I have. More about setting that up can be found here.\n\nGetting startedLets start by creating a config file and defining these stages.\nIn your project root create a new file called .gitlab-ci.yml and add the following lines:\n12345678image: edbizarro/gitlab-ci-pipeline-php:7.4stages:  - preparation  - building  - syntax  - testing  - deploy\nSo firstly we’re picking a base docker image to use for each of the tasks in the stages. I’ve been using the edbizarro image for a while now since they come with everything I’ve needed to test my apps so far:\n\nAll images come with PHP (with all laravel required extensions), Composer (with hirak/prestissimo to speed up installs), Node and Yarn.\n\nThis image is overridable at the task level but for every task that does not explicitly have an image: defined it will fall back to this image.\nNext we have the stages we want to create which is a simple list that we described before.\nStagesNow I’ll try show and break down the contents of each stage that has just been defined.\nBefore the doing so lets add a cache to help speed up builds. \n12cache:  key: \"$CI_JOB_NAME-$CI_COMMIT_REF_SLUG\"\nCache vs ArtifactsThis article explains the difference between what gitlab calls cache and artifacts. The top line is Artifacts can be passed between stages where as cache is used on the same server for subsequent runs of the same task. \nPreparation12345678910111213141516171819202122232425262728composer:  stage: preparation  script:    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts --no-suggest    - cp .env.example .env    - php artisan key:generate  artifacts:    paths:      - vendor/      - .env    expire_in: 1 days    when: always  cache:    paths:      - vendor/yarn:  stage: preparation  script:    - yarn install --pure-lockfile  artifacts:    paths:      - node_modules/    expire_in: 1 days    when: always  cache:    paths:    - node_modules/\nIn the previous articles what I’d been doing is fetching dependencies like composer install and yarn on pretty much every task on the pipeline. This wasted precious CI minutes and was inefficient. \nNow I run those tasks once store them as what artifacts and then fetch those artifacts in subsequent tasks on the pipeline.\nIn these two tasks I also cache the vendor and node_modules too so for subsequent pipelines being run on. Since these jobs are being allocated to either my server running the gitlab runner or the shared runners this cache doesn’t get hit very often. If you were to completely restrict your builds to run on a limited set of runners you’d see it being hit regularly giving you an additional improvement.\nBuilding1234567891011121314151617181920212223242526272829303132333435build-dev-assets:  stage: building  dependencies:    - yarn  script:    - echo \"PUSHER_APP_KEY=$PUSHER_TEST_APP_KEY\" &gt;&gt; .env    - yarn run dev --progress false  artifacts:    paths:      - public/css/      - public/js/      - public/fonts/      - public/mix-manifest.json    expire_in: 1 days    when: always  except:    - masterbuild-production-assets:  stage: building  dependencies:    - yarn  script:    - echo \"PUSHER_APP_KEY=$PUSHER_LIVE_APP_KEY\" &gt;&gt; .env    - yarn run production --progress false  artifacts:    paths:      - public/css/      - public/js/      - public/fonts/      - public/mix-manifest.json    expire_in: 1 days    when: always  only:    - master\nHere are two tasks which are almost the same. They’re both updating the .env file, then both running a yarn command to build the compiled front end assets and then creating artifacts of them. The key difference is one runs yarn production and is only run on the master branch where as the other runs yarn dev and runs on everything except master.\nI’ve written before about when you might need to update values on your .env file, here is an example of where I do that and how to create the variables being used above.\nSyntax12345678910111213php-cs-fixer:  stage: syntax  dependencies:    - composer  script:    - ./vendor/bin/php-cs-fixer fix --config=.php_cs.php --verbose --diff --dry-runeslint:  stage: syntax  dependencies:    - yarn  script:    - yarn eslint\nThese are the two tasks I run to check the syntax of the code being pushed up. One for php code and the other for the js code each pulling down the relevant artifacts to suit.\nTesting12345678910111213141516171819202122phpstan:  stage: testing  script:    - php artisan code:analysephpunit:  stage: testing  dependencies:    - composer  script:    - php -v    - php artisan storage:link    - sudo cp /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini /usr/local/etc/php/conf.d/docker-php-ext-xdebug.bak    - echo \"\" | sudo tee /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini    - ./vendor/phpunit/phpunit/phpunit --version    - php -d short_open_tag=off ./vendor/phpunit/phpunit/phpunit -v --colors=never --stderr --exclude-group integration    - sudo cp /usr/local/etc/php/conf.d/docker-php-ext-xdebug.bak /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini  artifacts:    paths:      - ./storage/logs    expire_in: 1 days    when: on_failure\nHere I use Larastan to perform static analysis on my projects in one task and phpunit in a second task. In the phpunit task the log file of the project is stored for a day when the task fails so we can refer back to it if necessary.\nDeploy123456789101112131415161718192021# Add a `.` in front of a job to make it hidden.# Add a `&amp;reference` to make it a reusable template.# Note that we don't have dashes anymore..init_ssh_live: &amp;init_ssh_live |  mkdir -p ~/.ssh  echo -e \"$SSH_PRIVATE_KEY\" &gt; ~/.ssh/id_rsa  chmod 600 ~/.ssh/id_rsa  [[ -f /.dockerenv ]] &amp;&amp; echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" &gt; ~/.ssh/configlive:  stage: deploy  script:    - *init_ssh_live    - php artisan deploy my-project.com -s upload  environment:    name: live    url: https://my-project.com  tags:    - deploy  only:    - master\nI use Laravel deployer to handle the deployment of my projects. I intend to do a whole other article about how I configure it and what needs to be done on the server to make this work.\nAs for this task itself it very simply adds the private key of a user who has access to the server into the docker container being run. Then uses deployer to handle everything else.\nI usually have a second version of this that deploys the develop branch of my projects to a staging server for our teams to test out the latest code changes before they are merged into master too.\nWrapping upThat concludes the breakdown of my current .gitlab.yml file. If you felt that this lacked clarity please reach out to me on twitter @talv and let me know how I can improve this.\n","dateCreated":"2020-03-06T10:13:49+00:00","dateModified":"2020-03-11T15:05:28+00:00","datePublished":"2020-03-06T10:13:49+00:00","description":"IntroductionMy most read articles on this blog are about Gitlab CI/CD with PHP. They cover a basic linting, testing and crude deploying process.\nToday I want to look at my current CI/CD process for my Laravel projects in more depth. Currently the pipelines of my projects might vary slightly but is very similar to this:\n \n So there are 5 main stages in the process:\n\nPreparation - The pulling down of dependencies and storing them in an artifact\nSyntax - Check code syntax\nTesting - Run unit tests\nBuilding - Build assets\nDeployment - Deploying to an appropriate server\n\nThe stages are processed in order with each stage containing one or many tasks. Should one task fails in a stage then the whole pipeline stops and is marked as failed.\nTo run the pipelines I make use of gitlabs free tier which gives you access to 2000 shared minutes per month as well as a runner on a server I have. More about setting that up can be found here.","headline":"In depth Gitlab CI/CD with Laravel Apps","image":["https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1583496063/posts/long-island-city-skyline.jpg","https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_1600/v1583496063/posts/long-island-city-skyline.jpg"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/"},"publisher":{"@type":"Organization","name":"Talv Bansal","sameAs":["https://github.com/talvbansal","https://twitter.com/talv","https://instagram.com/iwantthewindowseat","https://www.linkedin.com/in/talvinder-bansal-5826594a","mailto:talvbansal@outlook.com"],"image":"https://www.gravatar.com/avatar/be14e67a41106fe8731f839b3bd46733","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/be14e67a41106fe8731f839b3bd46733"}},"url":"https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/","keywords":"Gitlab, Laravel, PHP, Devops, CI/CD, Build, Deploy, Horizon","thumbnailUrl":"https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1583496063/posts/long-island-city-skyline.jpg"}</script> <meta name="description" content="IntroductionMy most read articles on this blog are about Gitlab CI/CD with PHP. They cover a basic linting, testing and crude deploying process. Today I want to look at my current CI/CD process for my">
<meta name="keywords" content="Gitlab,Laravel,PHP,Devops,CI&#x2F;CD,Build,Deploy,Horizon">
<meta property="og:type" content="blog">
<meta property="og:title" content="In depth Gitlab CI&#x2F;CD with Laravel Apps">
<meta property="og:url" content="https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/index.html">
<meta property="og:site_name" content="TalvBansal.me">
<meta property="og:description" content="IntroductionMy most read articles on this blog are about Gitlab CI/CD with PHP. They cover a basic linting, testing and crude deploying process. Today I want to look at my current CI/CD process for my">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://res.cloudinary.com/www-talvbansal-me/image/upload/v1583495330/posts/gitlab-ci-pipelines.png">
<meta property="og:updated_time" content="2020-03-11T15:05:28.300Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="In depth Gitlab CI&#x2F;CD with Laravel Apps">
<meta name="twitter:description" content="IntroductionMy most read articles on this blog are about Gitlab CI/CD with PHP. They cover a basic linting, testing and crude deploying process. Today I want to look at my current CI/CD process for my">
<meta name="twitter:image" content="https://res.cloudinary.com/www-talvbansal-me/image/upload/v1583495330/posts/gitlab-ci-pipelines.png">
<meta name="twitter:creator" content="@talv">     
  <meta property="og:image" content="https://www.gravatar.com/avatar/321065504328f47a4f9d8b57df0635f4?s=640" />
   
  <meta property="og:image" content="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1583496063/posts/long-island-city-skyline.jpg" />
  <meta class="swiftype" name="image" data-type="enum"
    content="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1583496063/posts/long-island-city-skyline.jpg" />
   
  <meta property="og:image" content="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_1600/v1583496063/posts/long-island-city-skyline.jpg" />
  <meta class="swiftype" name="image" data-type="enum" content="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_1600/v1583496063/posts/long-island-city-skyline.jpg" />
   
  <!--STYLES-->
  <link rel="stylesheet" href="/assets/css/style-du2xmrqdqrl2ollgeiw050kpl6l4nbyz7bumjuurjgsxyopifvukebxc9lqe.min.css">
  <!--STYLES END-->
  
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-82289929-1', 'auto');
        ga('send', 'pageview');
    </script>

 

  <script data-ad-client="ca-pub-9138914555599712" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>
    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">TalvBansal.me</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="https://www.gravatar.com/avatar/321065504328f47a4f9d8b57df0635f4?s=90" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/321065504328f47a4f9d8b57df0635f4?s=110" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Talv Bansal</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Full Stack Developer, Part Time Photographer</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/talvbansal" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://twitter.com/talv" target="_blank" rel="noopener" title="Twitter">
                    
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://instagram.com/iwantthewindowseat" target="_blank" rel="noopener" title="Instagram">
                    
                        <i class="sidebar-button-icon fab fa-instagram" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Instagram</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/talvinder-bansal-5826594a" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:talvbansal@outlook.com" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
        <div class="post-header-cover
                    text-center
                    post-header-cover--partial"
             style="background-image:url('https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_1600/v1583496063/posts/long-island-city-skyline.jpg');"
             data-behavior="4">
            
                <div class="post-header main-content-wrap text-center">
    
        <h1 class="post-title">
            In depth Gitlab CI/CD with Laravel Apps
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-03-06T10:13:49+00:00">
	
		    Mar 06, 2020
    	
    </time>
    
</div>

    
</div>

            
        </div>

            <div id="main" data-behavior="4"
                 class="hasCover
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>My most read articles on this blog are about <a href="/all-tags/#Gitlab-list">Gitlab CI/CD</a> with PHP. They cover a basic linting, testing and crude deploying process.</p>
<p>Today I want to look at my current CI/CD process for my Laravel projects in more depth. Currently the pipelines of my projects might vary slightly but is very similar to this:</p>
<p> <img src="https://res.cloudinary.com/www-talvbansal-me/image/upload/v1583495330/posts/gitlab-ci-pipelines.png" alt="Gitlab Pipeline"></p>
<p> So there are 5 main stages in the process:</p>
<ul>
<li><strong>Preparation</strong> - The pulling down of dependencies and storing them in an artifact</li>
<li><strong>Syntax</strong> - Check code syntax</li>
<li><strong>Testing</strong> - Run unit tests</li>
<li><strong>Building</strong> - Build assets</li>
<li><strong>Deployment</strong> - Deploying to an appropriate server</li>
</ul>
<p>The stages are processed in order with each stage containing one or many tasks. Should one task fails in a stage then the whole pipeline stops and is marked as failed.</p>
<p>To run the pipelines I make use of gitlabs free tier which gives you access to 2000 shared minutes per month as well as a runner on a server I have. More about setting that up can be found <a href="/blog/maximising-gitlab-ci-s-free-tier/">here</a>.</p>
<a id="more"></a>
<h2 id="Getting-started"><a href="#Getting-started" class="headerlink" title="Getting started"></a>Getting started</h2><p>Lets start by creating a config file and defining these stages.</p>
<p>In your project root create a new file called <code>.gitlab-ci.yml</code> and add the following lines:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">edbizarro/gitlab-ci-pipeline-php:7.4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">preparation</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">building</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">syntax</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">testing</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">deploy</span></span><br></pre></td></tr></table></figure>
<p>So firstly we’re picking a base docker image to use for each of the tasks in the stages. I’ve been using the <a href="https://github.com/edbizarro/gitlab-ci-pipeline-php" target="_blank" rel="noopener">edbizarro</a> image for a while now since they come with everything I’ve needed to test my apps so far:</p>
<blockquote>
<p>All images come with PHP (with all laravel required extensions), Composer (with hirak/prestissimo to speed up installs), Node and Yarn.</p>
</blockquote>
<p>This image is overridable at the task level but for every task that does not explicitly have an <code>image:</code> defined it will fall back to this image.</p>
<p>Next we have the stages we want to create which is a simple list that we described before.</p>
<h2 id="Stages"><a href="#Stages" class="headerlink" title="Stages"></a>Stages</h2><p>Now I’ll try show and break down the contents of each stage that has just been defined.</p>
<p>Before the doing so lets add a cache to help speed up builds. </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cache:</span></span><br><span class="line"><span class="attr">  key:</span> <span class="string">"$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"</span></span><br></pre></td></tr></table></figure>
<h4 id="Cache-vs-Artifacts"><a href="#Cache-vs-Artifacts" class="headerlink" title="Cache vs Artifacts"></a>Cache vs Artifacts</h4><p><a href="https://docs.gitlab.com/ee/ci/caching/#cache-vs-artifacts" target="_blank" rel="noopener">This article</a> explains the difference between what gitlab calls cache and artifacts. The top line is Artifacts can be passed between stages where as cache is used on the same server for subsequent runs of the same task. </p>
<h3 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">composer:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">preparation</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">composer</span> <span class="string">install</span> <span class="bullet">--prefer-dist</span> <span class="bullet">--no-ansi</span> <span class="bullet">--no-interaction</span> <span class="bullet">--no-progress</span> <span class="bullet">--no-scripts</span> <span class="bullet">--no-suggest</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cp</span> <span class="string">.env.example</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">php</span> <span class="string">artisan</span> <span class="attr">key:generate</span></span><br><span class="line"><span class="attr">  artifacts:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">vendor/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">.env</span></span><br><span class="line"><span class="attr">    expire_in:</span> <span class="number">1</span> <span class="string">days</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">vendor/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">yarn:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">preparation</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">yarn</span> <span class="string">install</span> <span class="bullet">--pure-lockfile</span></span><br><span class="line"><span class="attr">  artifacts:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">node_modules/</span></span><br><span class="line"><span class="attr">    expire_in:</span> <span class="number">1</span> <span class="string">days</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  cache:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">node_modules/</span></span><br></pre></td></tr></table></figure>
<p>In the previous articles what I’d been doing is fetching dependencies like composer install and yarn on pretty much every task on the pipeline. This wasted precious CI minutes and was inefficient. </p>
<p>Now I run those tasks once store them as what artifacts and then fetch those artifacts in subsequent tasks on the pipeline.</p>
<p>In these two tasks I also cache the <code>vendor</code> and <code>node_modules</code> too so for subsequent pipelines being run on. Since these jobs are being allocated to either my server running the gitlab runner or the shared runners this cache doesn’t get hit very often. If you were to completely restrict your builds to run on a limited set of runners you’d see it being hit regularly giving you an additional improvement.</p>
<h3 id="Building"><a href="#Building" class="headerlink" title="Building"></a>Building</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build-dev-assets:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">building</span></span><br><span class="line"><span class="attr">  dependencies:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">yarn</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"PUSHER_APP_KEY=$PUSHER_TEST_APP_KEY"</span> <span class="string">&gt;&gt;</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">yarn</span> <span class="string">run</span> <span class="string">dev</span> <span class="bullet">--progress</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  artifacts:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public/css/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public/js/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public/fonts/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public/mix-manifest.json</span></span><br><span class="line"><span class="attr">    expire_in:</span> <span class="number">1</span> <span class="string">days</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  except:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build-production-assets:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">building</span></span><br><span class="line"><span class="attr">  dependencies:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">yarn</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"PUSHER_APP_KEY=$PUSHER_LIVE_APP_KEY"</span> <span class="string">&gt;&gt;</span> <span class="string">.env</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">yarn</span> <span class="string">run</span> <span class="string">production</span> <span class="bullet">--progress</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  artifacts:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public/css/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public/js/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public/fonts/</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">public/mix-manifest.json</span></span><br><span class="line"><span class="attr">    expire_in:</span> <span class="number">1</span> <span class="string">days</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>Here are two tasks which are almost the same. They’re both updating the <code>.env</code> file, then both running a yarn command to build the compiled front end assets and then creating artifacts of them. The key difference is one runs <code>yarn production</code> and is only run on the <code>master</code> branch where as the other runs <code>yarn dev</code> and runs on everything <em>except</em> <code>master</code>.</p>
<p>I’ve written before about when you might need to update values on your <a href="/blog/updating-laravels-env-file-with-production-credentials-in-gitlab-ci-with-laravel-mix/">.env</a> file, here is an example of where I do that and how to create the variables being used above.</p>
<h3 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">php-cs-fixer:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">syntax</span></span><br><span class="line"><span class="attr">  dependencies:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">composer</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">./vendor/bin/php-cs-fixer</span> <span class="string">fix</span> <span class="bullet">--config=.php_cs.php</span> <span class="bullet">--verbose</span> <span class="bullet">--diff</span> <span class="bullet">--dry-run</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eslint:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">syntax</span></span><br><span class="line"><span class="attr">  dependencies:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">yarn</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">yarn</span> <span class="string">eslint</span></span><br></pre></td></tr></table></figure>
<p>These are the two tasks I run to check the syntax of the code being pushed up. One for php code and the other for the js code each pulling down the relevant artifacts to suit.</p>
<h3 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">phpstan:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">testing</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">php</span> <span class="string">artisan</span> <span class="attr">code:analyse</span></span><br><span class="line"></span><br><span class="line"><span class="attr">phpunit:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">testing</span></span><br><span class="line"><span class="attr">  dependencies:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">composer</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">php</span> <span class="bullet">-v</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">php</span> <span class="string">artisan</span> <span class="attr">storage:link</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">sudo</span> <span class="string">cp</span> <span class="string">/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span> <span class="string">/usr/local/etc/php/conf.d/docker-php-ext-xdebug.bak</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">""</span> <span class="string">| sudo tee /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span></span><br><span class="line"><span class="string">    - ./vendor/phpunit/phpunit/phpunit --version</span></span><br><span class="line"><span class="string">    - php -d short_open_tag=off ./vendor/phpunit/phpunit/phpunit -v --colors=never --stderr --exclude-group integration</span></span><br><span class="line"><span class="string">    - sudo cp /usr/local/etc/php/conf.d/docker-php-ext-xdebug.bak /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span></span><br><span class="line"><span class="string"></span><span class="attr">  artifacts:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./storage/logs</span></span><br><span class="line"><span class="attr">    expire_in:</span> <span class="number">1</span> <span class="string">days</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">on_failure</span></span><br></pre></td></tr></table></figure>
<p>Here I use <a href="https://github.com/nunomaduro/larastan" target="_blank" rel="noopener">Larastan</a> to perform static analysis on my projects in one task and phpunit in a second task. In the phpunit task the log file of the project is stored for a day when the task fails so we can refer back to it if necessary.</p>
<h3 id="Deploy"><a href="#Deploy" class="headerlink" title="Deploy"></a>Deploy</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add a `.` in front of a job to make it hidden.</span></span><br><span class="line"><span class="comment"># Add a `&amp;reference` to make it a reusable template.</span></span><br><span class="line"><span class="comment"># Note that we don't have dashes anymore.</span></span><br><span class="line"><span class="string">.init_ssh_live:</span> <span class="meta">&amp;init_ssh_live</span> <span class="string">|</span></span><br><span class="line"><span class="string">  mkdir -p ~/.ssh</span></span><br><span class="line"><span class="string">  echo -e "$SSH_PRIVATE_KEY" &gt; ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">  chmod 600 ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">  [[ -f /.dockerenv ]] &amp;&amp; echo -e "Host *\n\tStrictHostKeyChecking no\n\n" &gt; ~/.ssh/config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span><span class="attr">live:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="meta">*init_ssh_live</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">php</span> <span class="string">artisan</span> <span class="string">deploy</span> <span class="string">my-project.com</span> <span class="bullet">-s</span> <span class="string">upload</span></span><br><span class="line"><span class="attr">  environment:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">live</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">https://my-project.com</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">deploy</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>I use <a href="https://github.com/lorisleiva/laravel-deployer" target="_blank" rel="noopener">Laravel deployer</a> to handle the deployment of my projects. I intend to do a whole other article about how I configure it and what needs to be done on the server to make this work.</p>
<p>As for this task itself it very simply adds the private key of a user who has access to the server into the docker container being run. Then uses deployer to handle everything else.</p>
<p>I usually have a second version of this that deploys the develop branch of my projects to a staging server for our teams to test out the latest code changes before they are merged into master too.</p>
<h2 id="Wrapping-up"><a href="#Wrapping-up" class="headerlink" title="Wrapping up"></a>Wrapping up</h2><p>That concludes the breakdown of my current <code>.gitlab.yml</code> file. If you felt that this lacked clarity please reach out to me on twitter <a href="https://twitter.com/talv" target="_blank" rel="noopener">@talv</a> and let me know how I can improve this.</p>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Build/">Build</a> <a class="tag tag--primary tag--small t-link" href="/tags/CI-CD/">CI/CD</a> <a class="tag tag--primary tag--small t-link" href="/tags/Deploy/">Deploy</a> <a class="tag tag--primary tag--small t-link" href="/tags/Devops/">Devops</a> <a class="tag tag--primary tag--small t-link" href="/tags/Gitlab/">Gitlab</a> <a class="tag tag--primary tag--small t-link" href="/tags/Horizon/">Horizon</a> <a class="tag tag--primary tag--small t-link" href="/tags/Laravel/">Laravel</a> <a class="tag tag--primary tag--small t-link" href="/tags/PHP/">PHP</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/blog/easy-push-to-deploy-for-laravel-with-gitlab-ci/" data-tooltip="Easy push to deploy for Laravel with Gitlab CI" aria-label="PREVIOUS: Easy push to deploy for Laravel with Gitlab CI">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/blog/running-laravels-scheduler-as-a-non-root-user/" data-tooltip="Running Laravels scheduler as a non-root user" aria-label="NEXT: Running Laravels scheduler as a non-root user">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/" title="Share on Google+">
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#disqus_thread">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Talv Bansal. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/blog/easy-push-to-deploy-for-laravel-with-gitlab-ci/" data-tooltip="Easy push to deploy for Laravel with Gitlab CI" aria-label="PREVIOUS: Easy push to deploy for Laravel with Gitlab CI">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/blog/running-laravels-scheduler-as-a-non-root-user/" data-tooltip="Running Laravels scheduler as a non-root user" aria-label="NEXT: Running Laravels scheduler as a non-root user">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/" title="Share on Google+">
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#disqus_thread">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <i id="btn-close-shareoptions" class="fa fa-times"></i>
    <ul class="share-options">
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/">
                    <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/">
                    <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/">
                    <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                </a>
            </li>
        
    </ul>
</div>

            
        </div>
        


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/321065504328f47a4f9d8b57df0635f4?s=110" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Talv Bansal</h4>
        
            <div id="about-card-bio"><p>Full Stack Developer, Part Time Photographer</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Head of Software Engineering</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Remote
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">no post found</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/laravel-homestead-on-windows-10-with-bash-on-ubuntu/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352306/posts/south-africa-lion-male.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/laravel-homestead-on-windows-10-with-bash-on-ubuntu/">
                            <h3 class="media-heading">Laravel Homestead on Windows 10 with Bash On Ubuntu</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Aug 11, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>In preparation for <a href="http://laracon.eu/2016/" target="_blank" rel="noopener">Laracon EU</a> in a couple of weeks i figured I’d need to take a device along with me - paper and pen would probably have been fine but Laracon looks to be huge and i dont want to be unprepared, plus you always see rows of silver lids and glowing apple symbols in the photos from developer conferences! </p>
<p>I do almost all of my work on a Dell Precision 7710 which dual boots Ubuntu for development purposes and Windows for my photo editing. I also have a Surface Pro 4 which i use for note taking and photo editing on the go - <em>I’ll be writing about how I keep all of my photos in sync in a future post</em>!</p>
<p>Neither of the above are Macbooks but whilst the Dell Precision runs Ubuntu and anything else I can throw at it, it is HUGE and not ideal to take well … anywhere! So I figured I’d try and get a development environment set up on my Surface Pro 4 instead. </p>
<p>I’d heard of setups using Homestead / Vagrant / Virtualbox before, but since I was using Ubuntu, I’ve never had any need to explore it any further so this really is a guide for first timer noobs. The <a href="https://laravel.com/docs/5.2/homestead" target="_blank" rel="noopener">official Laravel Homestead guide</a> appears to be geared up mostly for Mac users, Windows users will need a bit more help which is where I’m hoping this post will help.</p>
<p>Anyway by the end of this guide I’ll have a Surface Pro 4 running Laravel Homestead and fingers crossed you’ll have a Windows device doing the same thing too! This has been a really long introduction, lets get to it!</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/finally-contributing-to-open-source/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352082/posts/south-africa-penguins.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/finally-contributing-to-open-source/">
                            <h3 class="media-heading">(Finally) Contributing to open source</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Aug 16, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>I once read an article on the merits of contributing to open source projects, within it i remember the author saying that the even smallest things can make all the difference. They even went on to say that their first commit was fixing a one character spelling mistake.</p>
<p>Open source software has provided me the tools to make my living as a software engineer over the past 9ish years, over that period I’ve always wanted to contribute back to the community to but for some reason I never actually have. Maybe I wasn’t looking in the right places, perhaps i was looking at the wrong projects when my skills weren’t where they needed who knows. I just knew that eventually I wanted to.</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/looking-back-on-laracon-eu-2016/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352383/posts/laracon-2016-stage.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/looking-back-on-laracon-eu-2016/">
                            <h3 class="media-heading">Looking back on Laracon EU 2016</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Aug 30, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>Earlier this week I attended my first “Big” Conference - <strong><a href="http://laracon.eu/2016/" target="_blank" rel="noopener">Laracon EU 2016</a></strong>. I’ve been to other tech conferences before but by comparison Laracon EU was <strong>HUGE</strong>, there were 650 people in attendance in one of the most incredible venues I’ve seen. I sent pictures back to my friends and home who said that it looked like a club night more than a conference!<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/setting-up-a-private-gitlab-server-on-ubuntu-1604/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352729/posts/st-basils-moscow.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/setting-up-a-private-gitlab-server-on-ubuntu-1604/">
                            <h3 class="media-heading">Setting up a private GitLab server on Ubuntu 16.04</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Sep 16, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Where I work, we’ve been using an Ubuntu Server running <a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="noopener">gitolite</a> to act as our “Source control server” and manage permissions and access. Its worked well, and after some initial configuration (which I recall being pretty tricky) looking after the gitolite instance has been pretty easy and could easily continue to serve our needs as a small business well.</p>
<p>Adding new users required you to get an ssh key from the new user, add it to an “administration repository” and then add their name to a config file within that repository. The same config file could then be used to determine which access rights they had to repositories as well as defining new repositories.</p>
<p>We also use a <a href="https://getcomposer.org/doc/articles/handling-private-packages-with-satis.md" target="_blank" rel="noopener">satis</a> install to act as a private composer for our internal private packages.</p>
<p>One of the things gitolite doesn’t provide you with is any sort of front end at all, everything has to be done through the terminal. It also requires you to have all of the following tools separately:</p>
<ul>
<li>Issue tracker</li>
<li>File browser</li>
<li>Activity stream</li>
<li>Pull request management</li>
</ul>
<p>Which are all features that github has built in natively. </p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/updating-a-satis-repository-on-git-push/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352875/posts/santorini-domes.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/updating-a-satis-repository-on-git-push/">
                            <h3 class="media-heading">Updating a Satis Repository on Git Push</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Sep 27, 2016
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p><strong>Update May 2017, looks like with the Gitab update to V9, which uses a new Gitlab API v4, Packages will not let you enable new repositories</strong></p>
<p>I’ve made amendments to the necessary files and packages on this fork:</p>
<p><a href="https://github.com/talvbansal/packages" target="_blank" rel="noopener">https://github.com/talvbansal/packages</a> on the “gitlab” branch.</p>
<p>As long as you change step 2 in the guide below everything should work as expected:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/talvbansal/packages</span><br><span class="line">cd packages</span><br><span class="line">git checkout gitlab</span><br><span class="line">composer install -o --no-dev</span><br></pre></td></tr></table></figure>
<hr>

<p>After moving our source control server from <strong><a href="http://gitolite.com/gitolite/index.html" target="_blank" rel="noopener">gitolite</a></strong> to a privately hosted <strong><a href="https://about.gitlab.com" target="_blank" rel="noopener">gitlab</a></strong> instance the next thing I wanted to do was get our internal <strong><a href="https://github.com/composer/satis" target="_blank" rel="noopener">Satis</a></strong> server to automatically update whenever code was pushed to a repository.<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/gitlab-ci-for-php-applications/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352188/posts/cancun-sunset.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/gitlab-ci-for-php-applications/">
                            <h3 class="media-heading">Gitlab CI for PHP applications</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Feb 24, 2017
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p><strong> Update March 2020 - I’ve given written a newer more updated version of this article, <a href="/blog/in-depth-gitlab-ci-cd-with-laravel-apps/">check it out over here.</a> </strong></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Gitlab provides some good documentation on getting build runners for your projects set up which can be found <a href="https://about.gitlab.com/2016/03/01/gitlab-runner-with-docker/" target="_blank" rel="noopener">here</a>. However I haven’t found a good article on setting up Gitlab CI for PHP applications yet. </p>
<p>This article is not going to discuss setting up shared runners on Gitlab since I felt the documentation provided by them in the link above was easy enough to follow, what this I am going to focus on is the <code>.gitlab-ci.yml</code> configuration that I’m currently using in my projects to do the following: </p>
<ul>
<li>Run PHP CS against our code base to ensure that it conforms to PSR-2</li>
<li>Run PHPUnit against our code base to ensure that our unit tests pass against different versions of PHP (5.6, 7.0, 7.1)</li>
</ul></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/simple-push-to-deploy-with-gitlab-cicd/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352778/posts/westminister-sunset.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/simple-push-to-deploy-with-gitlab-cicd/">
                            <h3 class="media-heading">Simple push to deploy with Gitlab CI/CD</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    May 24, 2017
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p><strong> Update March 2020 - I’ve given written a newer more updated version of this article, <a href="/blog/in-depth-gitlab-ci-cd-with-laravel-apps/">check it out over here.</a> </strong></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This article follows directly on from my <a href="/blog/gitlab-ci-for-php-applications">previous article</a> on adding gitlab’s CI to my PHP projects.</p>
<p>Once we’re happy with our code being automatically tested we might want it to be automatically deployed to a testing server / environment or maybe even production.<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/rsync-ing-data-between-servers/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352680/posts/new-york-skyline.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/rsync-ing-data-between-servers/">
                            <h3 class="media-heading">RSync-ing Data Between Servers</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Aug 20, 2017
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>After moving to NYC this week, I’ve found the need to move sets of data from my local machine to a server I have back at home in the UK.</p>
<p>Whilst I use <a href="https://www.resilio.com/" target="_blank" rel="noopener">Resilio sync</a> to keep things that i use regularly in sync between a number of devices this was more of a one off type deal so I decided to use the trusty command line tool rsync.<br></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/jquery-to-vue/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_280/v1555352239/posts/nyc-from-empire-state.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/jquery-to-vue/">
                            <h3 class="media-heading">jQuery to Vue</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jan 15, 2018
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>Recently I spoke at <a href="http://vuejs.nyc/" target="_blank" rel="noopener">VueNYC</a> about my journey from the world of jQuery to Vue and some of the problems people may have along the way:</p>
<p>Check it out below:</p>
<div class="video-container"><iframe src="//www.youtube.com/embed/7YiWLXzXFh4" frameborder="0" allowfullscreen></iframe></div>
<p>If you’re in NYC they have monthly meetups that you can sign up for over here : <a href="https://www.meetup.com/vueJsNYC" target="_blank" rel="noopener">VueNYC</a>. </p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-left">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/adding-eslint-to-your-laravel-application/">
                            <img class="media-image" src="https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,h_280/v1555351960/posts/portugal-tram.jpg" width="90" height="90"/>
                        </a>
                    </div>
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://talvbansal.me/blog/adding-eslint-to-your-laravel-application/">
                            <h3 class="media-heading">Adding eslint to your Laravel application</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Feb 4, 2018
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>My latest projects at work have evolved from being PHP / Laravel applications with sprinklings of Vue JS on the front end to being almost entirely Vue JS components driving the frontend with Laravel backends.</p>
<p>Whilst laravel ships with <a href="https://laravel.com/docs/master/mix" target="_blank" rel="noopener">Laravel-Mix</a> to make webpack / asset compilation easier it doesn’t ship with anyway to lint your javascript.</p>
<p>Luckily adding <a href="https://eslint.org/" target="_blank" rel="noopener">eslint</a> and defining rules for your <code>.js</code> and <code>.vue</code> files to follow is pretty straight forward.</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="no post found"
                data-message-one="1 post found"
                data-message-other="{n} posts found">
                30 posts found
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('https://res.cloudinary.com/www-talvbansal-me/image/upload/c_scale,w_1600/v1556584444/posts/manhattan-skyline.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-vufjrm3fmbuttogo1hxuu0w9w0sesk5iyysjuguc2hdhufot9szxg8twijry.min.js"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'https://talvbansal.me/blog/in-depth-gitlab-ci-cd-with-laravel-apps/';
                 
                    this.page.identifier = 'blog/in-depth-gitlab-ci-cd-with-laravel-apps/';
                 
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'talvbansalblog';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    


    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script>
    <script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
    <script>
        var algoliaClient = algoliasearch('CXJDW0GFV9', '17c6a414fdfe63fab45294772bf9a689');
        var algoliaIndex = algoliaClient.initIndex('talvbansal.me');
    </script>


    </body>
</html>
